---
// ThemeToggle.astro - Theme switcher with Light, Dark, and System options (icons only)
---

<div class="theme-toggle" role="radiogroup" aria-label="Theme switcher">
  <button
    class="theme-option"
    data-theme-option="light"
    role="radio"
    aria-checked="false"
    aria-label="Switch to light mode"
    title="Light mode"
  >
    <span class="theme-icon">‚òÄÔ∏è</span>
  </button>
  <button
    class="theme-option"
    data-theme-option="system"
    role="radio"
    aria-checked="false"
    aria-label="Use system theme"
    title="System theme"
  >
    <span class="theme-icon">üíª</span>
  </button>
  <button
    class="theme-option"
    data-theme-option="dark"
    role="radio"
    aria-checked="true"
    aria-label="Switch to dark mode"
    title="Dark mode"
  >
    <span class="theme-icon">üåô</span>
  </button>
  <div class="theme-indicator" aria-hidden="true"></div>
</div>

<style>
  .theme-toggle {
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 0;
    padding: 0.2rem;
    border-radius: 999px;
    border: 1px solid var(--surface-border);
    background: var(--surface-soft);
    backdrop-filter: blur(8px);
    box-shadow: 0 2px 8px -4px rgba(15, 23, 42, 0.1);
  }

  .theme-option {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.4rem;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    cursor: pointer;
    border-radius: 999px;
    transition: color 0.3s ease;
    z-index: 2;
    min-width: 32px;
  }

  .theme-option[aria-checked="true"] {
    color: var(--text-primary);
  }

  .theme-icon {
    font-size: 1rem;
    line-height: 1;
    filter: grayscale(0.3);
    transition: filter 0.3s ease;
  }

  .theme-option[aria-checked="true"] .theme-icon {
    filter: grayscale(0);
  }

  .theme-indicator {
    position: absolute;
    top: 0.2rem;
    left: 0.2rem;
    width: calc(33.333% - 0.13rem);
    height: calc(100% - 0.4rem);
    background: linear-gradient(135deg, rgba(56, 189, 248, 0.20), rgba(102, 187, 106, 0.15));
    border: 1px solid color-mix(in srgb, var(--accent-electric) 60%, var(--accent-lime));
    border-radius: 999px;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1;
    pointer-events: none;
    box-shadow: 0 2px 8px -2px rgba(102, 187, 106, 0.25), 0 2px 8px -2px rgba(56, 189, 248, 0.2);
  }

  /* Indicator positions for each option */
  .theme-toggle[data-active="light"] .theme-indicator {
    transform: translateX(0);
  }

  .theme-toggle[data-active="system"] .theme-indicator {
    transform: translateX(100%);
  }

  .theme-toggle[data-active="dark"] .theme-indicator {
    transform: translateX(200%);
  }

  .theme-option:hover {
    color: var(--text-primary);
  }

  .theme-option:hover .theme-icon {
    filter: grayscale(0);
  }

  .theme-option:focus-visible {
    outline: 2px solid var(--accent-electric);
    outline-offset: 2px;
  }
</style>

<script>
  function initThemeToggle() {
    const toggleContainer = document.querySelector('.theme-toggle');
    if (!toggleContainer) return;

    const options = toggleContainer.querySelectorAll('.theme-option');

    // Update UI to match current preference
    function updateToggleUI(preference: string) {
      toggleContainer.setAttribute('data-active', preference);
      options.forEach(option => {
        const optionTheme = option.getAttribute('data-theme-option');
        const isActive = optionTheme === preference;
        option.setAttribute('aria-checked', isActive.toString());
      });
    }

    // Handle toggle clicks
    options.forEach(option => {
      option.addEventListener('click', () => {
        const newPreference = option.getAttribute('data-theme-option');
        if (newPreference) {
          // Dispatch custom event that Layout.astro will listen for
          document.dispatchEvent(new CustomEvent('theme-preference-change', {
            detail: { preference: newPreference }
          }));
        }
      });
    });

    // Listen for preference changes from other sources
    document.addEventListener('theme-preference-changed', ((e: CustomEvent) => {
      updateToggleUI(e.detail.preference);
    }) as EventListener);

    // Initialize UI on load - get the stored preference
    const storedPreference = localStorage.getItem('theme-preference') || 'system';
    updateToggleUI(storedPreference);
  }

  initThemeToggle();
  document.addEventListener('astro:page-load', initThemeToggle);
</script>
